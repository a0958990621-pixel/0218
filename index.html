let curr = 0; const pages = document.querySelectorAll('.page');
        const m1 = document.getElementById('music-1');
        let bookStarted = false;

        // 頁面加載時：強制回到初始狀態
        window.onload = function() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-overlay').style.opacity = '1';
            document.getElementById('myBook').style.display = 'none';
            document.getElementById('pwd').value = ""; 
        };

        function reveal(overlay) { overlay.classList.add('revealed'); }
        
        function wakeUpAudio() { 
            if (bookStarted && m1.paused) m1.play().catch(()=>{}); 
        }

        function checkPwd() {
            if (document.getElementById('pwd').value === '20250424') {
                m1.play().catch(()=>{});
                document.getElementById('login-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('myBook').style.display = 'block';
                    bookStarted = true;
                    loadVideo(0);
                }, 800);
            } else { alert("密碼錯誤喔！"); }
        }

        function loadVideo(index) {
            const v = pages[index].querySelector('.page-video');
            if(v && (!v.src || v.src === "")) { v.src = v.getAttribute('data-src'); v.load(); v.onended = v.onpause = wakeUpAudio; }
        }

        function nextPage() {
            if (curr < pages.length - 1) {
                const v = pages[curr].querySelector('video'); if(v) v.pause();
                pages[curr].classList.add('flipped'); curr++; loadVideo(curr); updateButtons(); wakeUpAudio();
            }
        }

        function prevPage() {
            if (curr > 0) {
                const v = pages[curr].querySelector('video'); if(v) v.pause();
                curr--; pages[curr].classList.remove('flipped'); loadVideo(curr); updateButtons(); wakeUpAudio();
            }
        }

        function updateButtons() {
            document.getElementById('prevBtn').disabled = (curr === 0);
            document.getElementById('nextBtn').disabled = (curr === pages.length - 1 || pages[curr].id === "trigger-page");
        }

        function playSurpriseVideo() {
            m1.pause(); // 暫停原本的 Anti-Romantic
            document.getElementById('video-wrapper').innerHTML = `<iframe id="yt-frame" src="https://www.youtube.com/embed/e4bQwcrrN9A?autoplay=1&enablejsapi=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            document.getElementById('final-video-container').style.display = 'flex';
            setTimeout(()=>document.getElementById('final-video-container').style.opacity = '1', 50);
        }

        // 重點修正：按下叉叉後的邏輯
        function closeFinalVideo() {
            document.getElementById('video-wrapper').innerHTML = "";
            document.getElementById('final-video-container').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('final-video-container').style.display = 'none';
                document.getElementById('flower-main').style.display = "none";
                document.getElementById('trigger-text').style.display = "none";
                document.getElementById('after-video-ui').style.display = "block";
                
                // 換歌邏輯：更換音樂來源並播放五月天
                m1.src = "五月天-為你寫下這首情歌.mp3"; 
                m1.load();
                m1.play().catch(()=>{});
            }, 600);
        }

        window.addEventListener('keydown', (e) => {
            if (!bookStarted) return;
            if ((e.key === "ArrowRight" || e.key === " ") && (pages[curr].id !== "trigger-page")) nextPage();
            else if (e.key === "ArrowLeft") prevPage();
        });

        document.getElementById('pwd').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPwd(); });